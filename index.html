<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title></title>

    <script type="text/javascript" src="mist-designer/bower_components/requirejs/require.js"></script>

    <script type="text/javascript">

        (function() {

            var designer = {};
            designer.diagramDB = require("./db/diagrams");

            require.config({
                baseUrl: 'mist-designer',
                paths: {
                    'd3': 'bower_components/d3/d3',
                    'd3utils': 'bower_components/diagram-designer-core/js/helpers/d3utils',
                    'jquery': 'bower_components/jquery/dist/jquery',
                    'handlebars': 'bower_components/handlebars/handlebars',
                    'backbone': 'bower_components/backbone/backbone',
                    'marionette': 'bower_components/backbone.marionette/lib/backbone.marionette',
                    'underscore': 'bower_components/underscore/underscore'
                }
            });

            require(["handlebars", "d3", "jquery", "underscore"], function (handlebars, d3, jquery, underscore) {
                window.Handlebars = handlebars;
                window.d3 = d3;
                window.$ = jquery;
                window._ = underscore;
                require(["backbone"], function () {
                    require(["marionette"], function () {
                        require(['app/app', './db/diagrams'], function (DiagramApplication, diagramDB) {
                            window.application = new DiagramApplication();
                            window.application.start();

                            if (designer.pendingLoad)
                                designer.reloadSelectedDiagram();
                        });
                    });
                });

                $(function () {

                    designer.refreshDiagrams = function () {
                        designer.diagramDB.listDiagrams(function (diagrams) {
                            var html = ["<select name='diagramSelector'>"];

                            for (var i = 0; i < diagrams.length; i++) {
                                html.push("<option value='" + diagrams[i] + "'>" + diagrams[i] + "</option>");
                            }

                            html.push("</select>");

                            $(".diagram-selector").html(html.join(""));

                            var $menuItem = $(".diagram-selector > select");

                            $menuItem.change(function () {
                                designer.changeSelectedDiagram(global.$(this).val());
                            });

                            if (designer.selectedDiagram)
                                $menuItem.val(designer.selectedDiagram);
                            else if (diagrams.length > 0) {
                                designer.changeSelectedDiagram(diagrams[0]);
                            }

                        })
                    };

                    designer.changeSelectedDiagram = function (diagram) {
                        designer.selectedDiagram = diagram;
                        designer.pendingLoad = true;

                        if (!designer.application)
                            return;

                        designer.reloadSelectedDiagram();
                    };

                    designer.reloadSelectedDiagram = function () {
                        designer.pendingLoad = false;

                        designer.diagramDB.loadDiagram(global.selectedDiagram, function (json) {
                            designer.application.diagram.updateFromCollection();
                            designer.application.diagram.setCollection(JSON.parse(json));
                        });

                    };

                    designer.saveDiagram = function () {
                        var json = JSON.stringify(global.application.diagram.collection.models);
                        designer.diagramDB.overwriteDiagram(global.selectedDiagram, json);
                    };

                    $(".add-diagram").on("click", function () {

                        var diagramName = prompt("New diagram", "");

                        if (diagramName) {
                            designer.diagramDB.addDiagram(diagramName, function () {
                                designer.refreshDiagrams();
                                designer.changeSelectedDiagram(diagramName);

                            })
                        }
                    });

                    $(".save-diagram").on("click", designer.saveDiagram);

                    designer.refreshDiagrams();
                })


            });
        })();

    </script>

    <script type="text/javascript">

    </script>

    <link href="demo/diagram.css" rel="stylesheet" />

</head>



<body>
    <span class="diagram-selector little-menu no-select"></span>

    <span class="add-diagram little-menu no-select">+</span>

    <span class="save-diagram little-menu no-select">save</span>

    <div class="js-graphContainer"></div>
</body>
</html>